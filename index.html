<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>记牌器</title>
  <style>
    #box {
      display: flex;
      justify-content: center;
      align-items: stretch;
      user-select: none;
    }

    .card {
      position: relative;
      border-radius: 10px;
      width: 100px;
      height: 160px; /* 增加高度以容纳按钮 */
      background-color: #f5f5f5;
      margin: 20px 12px 0; /* 增加上方和左右的间距，美化样式 */
      box-shadow: 0 5px 5px 0 #c9c9c9;
      font-size: 28px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      padding-bottom: 10px; /* 适当调整底部内距 */
    }

    .card--empty {
      color: #c3c3c3;
      opacity: 0.8;
    }

    .card--chosen {
      margin-top: 0;
    }

    .btn-container {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px; /* 调整按钮容器的底部间距 */
    }

    .ctrl-btn {
      background-color: transparent;
      color: orangered;
      border: none;
      font-size: 18px;
      padding: 1px;
      cursor: pointer;
      transition: transform 0.3s ease;
      outline: none;
      margin: 0 5px;
    }

    .ctrl-btn:active {
      transform: scale(0.9);
    }

    .ctrl-btn:hover {
      color: red;
    }

    .card-count {
      font-size: 18px;
      color: orangered;
      margin: 0 5px; /* 设置左右间距 */
    }

    .card--warning .card-count {
      color: red;
      font-weight: bold;
    }

    #btn-box {
      text-align: center;
      margin-top: 30px;
    }

    .info {
      font-size: 14px;
      margin-top: 70px;
      color: #999;
    }
  </style>
</head>

<body>
<div id="box"></div>
<div class="info">
  <p>作者: <a href="http://www.leelei.info">leelei</a></p>
  <p>用法: 鼠标【点击】直接出牌，或者【点击滑动】出牌，右键单击某张牌可以增加牌数(用于防止点错)</p>
</div>
<script>
  const arr = ['👑', '⚔', '2', 'A', 'K', 'Q', 'J'];
  const nums = [4, 4, 16, 16, 16, 16, 16];
  const TYPE_CHOSEN = ' card--chosen';
  const TYPE_WARNING = ' card--warning';
  const TYPE_EMPTY = ' card--empty';

  let chosenArr = [];
  let history = [];

  function addClass(e, name) {
    if (e.className.indexOf(name) === -1) {
      e.className += name;
    }
  }

  function removeClass(e, name) {
    e.className = e.className.replace(name, '');
  }

  function initCards() {
    let box = document.getElementById('box');
    let frag = document.createDocumentFragment();
    for (let i = 0; i < 7; i++) {
      let ele = document.createElement('div');
      ele.className = 'card' + TYPE_WARNING;
      ele.innerText = arr[i];
      ele.setAttribute('index', i);

      let btnContainer = document.createElement('div');
      btnContainer.className = 'btn-container';

      // 创建增加数量按钮
      let increaseBtn = document.createElement('button');
      increaseBtn.className = 'ctrl-btn';
      increaseBtn.innerHTML = '&#9650;';
      increaseBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        changeCount(ele, 1);
      });

      let countDisplay = document.createElement('span');
      countDisplay.className = 'card-count';
      countDisplay.innerText = nums[i];
      countDisplay.setAttribute('count', nums[i]);

      // 创建减少数量按钮
      let decreaseBtn = document.createElement('button');
      decreaseBtn.className = 'ctrl-btn';
      decreaseBtn.innerHTML = '&#9660;';
      decreaseBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        changeCount(ele, -1);
      });

      // 对调位置
      btnContainer.appendChild(increaseBtn);
      btnContainer.appendChild(countDisplay);
      btnContainer.appendChild(decreaseBtn);
      ele.appendChild(btnContainer);
      frag.appendChild(ele);

      ele.setAttribute('count', nums[i]);
    }
    box.appendChild(frag);
  }

  function initSlideInput() {
    let box = document.getElementById('box');
    let cards = document.getElementsByClassName('card');

    box.addEventListener('mousedown', installSlideInput);
    box.addEventListener('mouseup', uninstallSlideInput);
    box.addEventListener('mouseleave', uninstallSlideInput);

    function installSlideInput() {
      Array.from(cards).forEach((e) => {
        e.addEventListener('mouseenter', slideSelect);
        e.addEventListener('mouseleave', slideSelect);
      });
    }

    function uninstallSlideInput() {
      Array.from(cards).forEach((e) => {
        e.removeEventListener('mouseenter', slideSelect);
        e.removeEventListener('mouseleave', slideSelect);
      });
      submit();
    }

    Array.from(cards).forEach((e) => {
      e.addEventListener('click', function (event) {
        slideSelect(event);
        submit();
      });
    });

    function slideSelect(event) {
      let idx = event.currentTarget.getAttribute('index');
      if (event.currentTarget.className.indexOf(TYPE_CHOSEN) === -1) {
        addClass(event.currentTarget, TYPE_CHOSEN);
        chosenArr.push(idx);
      }
    }
  }

  function reset() {
    chosenArr = [];
    let cards = document.getElementsByClassName('card');
    Array.from(cards).forEach((v) => {
      removeClass(v, TYPE_CHOSEN);
    });
  }

  function recordHistory() {
    let currentState = [];
    let cards = document.getElementsByClassName('card');
    Array.from(cards).forEach((card) => {
      currentState.push({
        count: parseInt(card.querySelector('.card-count').innerText),
        index: card.getAttribute('index'),
        className: card.className
      });
    });
    history.push(currentState);
  }

  function submit() {
    if (chosenArr.length > 0) {
      recordHistory();
    }
    let cards = document.getElementsByClassName('card');
    chosenArr.forEach((v) => {
      let card = cards[v];
      let countDisplay = card.querySelector('.card-count');
      let newCount = parseInt(countDisplay.innerText) - 1;
      countDisplay.innerText = newCount;
      card.setAttribute('count', newCount);
      removeClass(card, TYPE_WARNING);
      if (newCount < 1) {
        countDisplay.innerText = 0;
        card.setAttribute('count', 0);
        addClass(card, TYPE_EMPTY);
      }
    });
    reset();
  }

  function changeCount(card, delta) {
    let countDisplay = card.querySelector('.card-count');
    let count = parseInt(countDisplay.innerText) + delta;
    let index = card.getAttribute('index');
    if (count >= 0 && count <= nums[index]) {
      countDisplay.innerText = count;
      card.setAttribute('count', count);
      if (count === 0) {
        addClass(card, TYPE_EMPTY);
        removeClass(card, TYPE_WARNING);
      } else if (count === nums[index]) {
        addClass(card, TYPE_WARNING);
        removeClass(card, TYPE_EMPTY);
      } else {
        removeClass(card, TYPE_EMPTY);
        removeClass(card, TYPE_WARNING);
      }
    }
  }

  function addCardCount(e) {
    if (e && e.querySelector && e.querySelector('.card-count')) {
      let countDisplay = e.querySelector('.card-count');
      let count = parseInt(countDisplay.innerText) + 1;
      let index = e.getAttribute('index');
      if (count <= nums[index]) {
        countDisplay.innerText = count;
        e.setAttribute('count', count);
        if (count === nums[index]) {
          addClass(e, TYPE_WARNING);
        } else if (count > 0) {
          removeClass(e, TYPE_EMPTY);
        }
      }
    }
  }

  window.onload = function () {
    document.oncontextmenu = function (event) {
      event.preventDefault();
      if (event.button === 2) {
        addCardCount(event.target);
      }
    };
    initCards();
    initSlideInput();
  }
</script>
</html>
